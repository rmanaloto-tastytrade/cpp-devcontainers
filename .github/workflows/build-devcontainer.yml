name: Build Devcontainers (Docker Bake)

on:
  push:
    branches: [ "main", "modernization.20251118" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: devcontainers-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  BUILDX_NO_DEFAULT_LOAD: 1
  TAG_BASE: ghcr.io/${{ github.repository }}/devcontainer
  EXPECTED_RUNNER_NAME: c0802s4-000
  EXPECTED_RUNNER_ALT: c0802s4

jobs:
  build-ci-helper:
    name: Build CI helper image
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4
    permissions:
      contents: read
      packages: write
      id-token: write
    timeout-minutes: 60
    steps:
      - name: Runner guard
        run: |
          actual="$(hostname)"
          expected="${EXPECTED_RUNNER_NAME:-}"
          alt="${EXPECTED_RUNNER_ALT:-}"
          if [ -n "$expected" ] && [ "$actual" != "$expected" ] && { [ -z "$alt" ] || [ "$actual" != "$alt" ]; }; then
            echo "Runner guard failed: expected ${expected}${alt:+ or ${alt}}, got ${actual}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Metadata for helper
        id: meta-helper
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/rmanaloto-tastytrade/cpp-devcontainers/ci-helper
          tags: |
            type=sha,format=short
            type=raw,value=latest

      - name: Build & push helper (bake)
        uses: docker/bake-action@v6
        with:
          files: .devcontainer/docker-bake.hcl
          targets: ci-helper
          push: true
          set: |
            ci-helper.tags=${{ steps.meta-helper.outputs.tags }}
            ci-helper.labels=${{ steps.meta-helper.outputs.labels }}
          cache-from: type=gha,scope=ci-helper-${{ github.ref_name }}
          cache-to: type=gha,scope=ci-helper-${{ github.ref_name }},mode=max

      - name: Cleanup builder cache
        if: always()
        run: |
          docker builder prune -f --filter until=24h || true
          docker image prune -f --filter until=24h || true

  build-devcontainers:
    name: Build devcontainer matrix
    needs: build-ci-helper
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4
    permissions:
      contents: read
      packages: write
      id-token: write
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        permutation:
          - gcc14-clang21
          - gcc14-clang22
          - gcc14-clangp2996
          - gcc15-clang21
          - gcc15-clang22
          - gcc15-clangp2996
    steps:
      - name: Runner guard
        run: |
          actual="$(hostname)"
          expected="${EXPECTED_RUNNER_NAME:-}"
          alt="${EXPECTED_RUNNER_ALT:-}"
          if [ -n "$expected" ] && [ "$actual" != "$expected" ] && { [ -z "$alt" ] || [ "$actual" != "$alt" ]; }; then
            echo "Runner guard failed: expected ${expected}${alt:+ or ${alt}}, got ${actual}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Metadata for devcontainer
        id: meta-dev
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.TAG_BASE }}
          tags: |
            type=raw,value=${{ matrix.permutation }}
            type=sha,format=short,prefix=${{ matrix.permutation }}-
            type=raw,value=latest-${{ matrix.permutation }},enable=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

      - name: Map permutation to bake target
        id: map
        run: |
          case "${{ matrix.permutation }}" in
            gcc14-clang21) echo "target=devcontainer_gcc14_clang_qual" >> $GITHUB_OUTPUT ;;
            gcc14-clang22) echo "target=devcontainer_gcc14_clang_dev" >> $GITHUB_OUTPUT ;;
            gcc14-clangp2996) echo "target=devcontainer_gcc14_clangp2996" >> $GITHUB_OUTPUT ;;
            gcc15-clang21) echo "target=devcontainer_gcc15_clang_qual" >> $GITHUB_OUTPUT ;;
            gcc15-clang22) echo "target=devcontainer_gcc15_clang_dev" >> $GITHUB_OUTPUT ;;
            gcc15-clangp2996) echo "target=devcontainer_gcc15_clangp2996" >> $GITHUB_OUTPUT ;;
            *) echo "Unknown permutation" >&2; exit 1 ;;
          esac

      - name: Build base locally (no push)
        uses: docker/bake-action@v6
        with:
          files: .devcontainer/docker-bake.hcl
          targets: base
          load: true
          push: false
          cache-from: type=gha,scope=base-${{ github.ref_name }}
          cache-to: type=gha,scope=base-${{ github.ref_name }},mode=max

      - name: Build devcontainer (bake)
        uses: docker/bake-action@v6
        with:
          files: .devcontainer/docker-bake.hcl
          targets: ${{ steps.map.outputs.target }}
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          load: ${{ github.event_name != 'push' || github.ref != 'refs/heads/main' }}
          set: |
            ${{ steps.map.outputs.target }}.tags=${{ steps.meta-dev.outputs.tags }}
            ${{ steps.map.outputs.target }}.labels=${{ steps.meta-dev.outputs.labels }}
          cache-from: type=gha,scope=devcontainer-${{ matrix.permutation }}-${{ github.ref_name }}
          cache-to: type=gha,scope=devcontainer-${{ matrix.permutation }}-${{ github.ref_name }},mode=max

      - name: Cleanup builder cache
        if: always()
        run: |
          docker builder prune -f --filter until=24h || true
          docker image prune -f --filter until=24h || true
