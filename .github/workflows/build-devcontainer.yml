name: Build Devcontainers (Docker Bake)

on:
  push:
    branches: [ "main", "modernization.20251118" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: devcontainers-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  BUILDX_NO_DEFAULT_LOAD: 1
  TAG_BASE: ghcr.io/${{ github.repository }}/devcontainer
  BASE_IMAGE_TAG: cpp-dev-base:local
  BASE_CACHE_TAG: ghcr.io/${{ github.repository }}/cpp-dev-base:cache
  SUMMARY_JSON: devcontainer-summary.json
  EXPECTED_RUNNER_NAME: c0802s4-000
  EXPECTED_RUNNER_ALT: c0802s4
  CACHE_DIR: /var/cache/docker-buildx

jobs:
  build-ci-helper:
    name: Build CI helper image
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4
    permissions:
      contents: read
      packages: write
      id-token: write
    timeout-minutes: 60
    steps:
      - name: Derive cache dir from Docker root
        id: cachepath-helper
        run: |
          set -euo pipefail
          root="$(docker info --format '{{.DockerRootDir}}')"
          target="${root}/buildx-cache"
          if sudo -n true 2>/dev/null; then
            sudo mkdir -p "$target"
            sudo chown "$(id -u):$(id -g)" "$target"
          else
            mkdir -p "$target" || true
          fi
          if [ -w "$target" ]; then
            echo "CACHE_DIR=$target" >> "$GITHUB_ENV"
          else
            fallback="${HOME}/.cache/docker-buildx"
            mkdir -p "$fallback"
            echo "CACHE_DIR=$fallback" >> "$GITHUB_ENV"
          fi

      - name: Runner guard
        run: |
          actual="$(hostname)"
          expected="${EXPECTED_RUNNER_NAME:-}"
          alt="${EXPECTED_RUNNER_ALT:-}"
          if [ -n "$expected" ] && [ "$actual" != "$expected" ] && { [ -z "$alt" ] || [ "$actual" != "$alt" ]; }; then
            echo "Runner guard failed: expected ${expected}${alt:+ or ${alt}}, got ${actual}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build metadata
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          echo "BUILD_TS=$(date +%Y%m%d%H%M%S.%N)" >> "$GITHUB_ENV"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1

      - name: Pre-pull buildkit/frontend images
        run: |
          docker pull moby/buildkit:buildx-stable-1 || true
          docker pull ghcr.io/docker/dockerfile:1.7 || true

      - name: Metadata for helper
        id: meta-helper
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/rmanaloto-tastytrade/cpp-devcontainers/ci-helper
          bake-target: ci-helper
          tags: |
            type=sha,format=short
            type=raw,value=latest

      - name: Persist helper metadata bake file
        run: cp "${{ steps.meta-helper.outputs.bake-file }}" meta-helper-bake.json

      - name: Build & push helper (bake)
        uses: docker/bake-action@v6
        with:
          workdir: ${{ github.workspace }}
          source: .
          files: |
            .devcontainer/docker-bake.hcl
            meta-helper-bake.json
          targets: ci-helper
          push: true

      - name: Cleanup builder cache
        if: always()
        run: |
          docker builder prune -f --filter until=24h || true
          docker image prune -f --filter until=24h || true

  build-devcontainers:
    name: Build devcontainers
    needs: build-ci-helper
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4
    permissions:
      contents: read
      packages: write
      id-token: write
    timeout-minutes: 120
    steps:
      - name: Derive cache dir from Docker root
        id: cachepath-dev
        run: |
          set -euo pipefail
          root="$(docker info --format '{{.DockerRootDir}}')"
          target="${root}/buildx-cache"
          if sudo -n true 2>/dev/null; then
            sudo mkdir -p "$target"
            sudo chown "$(id -u):$(id -g)" "$target"
          else
            mkdir -p "$target" || true
          fi
          if [ -w "$target" ]; then
            echo "CACHE_DIR=$target" >> "$GITHUB_ENV"
          else
            fallback="${HOME}/.cache/docker-buildx"
            mkdir -p "$fallback"
            echo "CACHE_DIR=$fallback" >> "$GITHUB_ENV"
          fi

      - name: Runner guard
        run: |
          actual="$(hostname)"
          expected="${EXPECTED_RUNNER_NAME:-}"
          alt="${EXPECTED_RUNNER_ALT:-}"
          if [ -n "$expected" ] && [ "$actual" != "$expected" ] && { [ -z "$alt" ] || [ "$actual" != "$alt" ]; }; then
            echo "Runner guard failed: expected ${expected}${alt:+ or ${alt}}, got ${actual}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build metadata
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          echo "BUILD_TS=$(date +%Y%m%d%H%M%S.%N)" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate bake targets
        run: docker buildx bake --file .devcontainer/docker-bake.hcl --print

      - name: Guard against docker.io fallback
        run: |
          case "${BASE_IMAGE_TAG}" in
            ghcr.io/*|localhost/*|cpp-dev-base:local) ;;
            *) echo "BASE_IMAGE_TAG must be ghcr.io/* or localhost/*, got ${BASE_IMAGE_TAG}"; exit 1 ;;
          esac
          case "${BASE_CACHE_TAG}" in
            ghcr.io/*) ;;
            *) echo "BASE_CACHE_TAG must be ghcr.io/*, got ${BASE_CACHE_TAG}"; exit 1 ;;
          esac
          BASE_TAG=${{ env.BASE_IMAGE_TAG }} BASE_CACHE_TAG=${{ env.BASE_CACHE_TAG }} \
            docker buildx bake --file .devcontainer/docker-bake.hcl --print base > /tmp/bake-print.txt
          if grep -Ei "docker\\.io|library/" /tmp/bake-print.txt; then
            echo "docker.io reference detected in base bake plan"
            exit 1
          fi
          if grep -Ei "cache-(from|to).*(docker\\.io|library/)" /tmp/bake-print.txt; then
            echo "docker.io reference detected in base cache refs"
            exit 1
          fi
          for tgt in devcontainer_gcc14_clang_qual devcontainer_gcc14_clang_dev devcontainer_gcc14_clangp2996 devcontainer_gcc15_clang_qual devcontainer_gcc15_clang_dev devcontainer_gcc15_clangp2996; do
            BASE_TAG=${{ env.BASE_IMAGE_TAG }} BASE_CACHE_TAG=${{ env.BASE_CACHE_TAG }} \
              docker buildx bake --file .devcontainer/docker-bake.hcl --print "$tgt" > "/tmp/bake-${tgt}.txt"
            if grep -Ei "docker\\.io|library/" "/tmp/bake-${tgt}.txt"; then
              echo "docker.io reference detected in permutation bake plan ($tgt)"
              exit 1
            fi
            if grep -Ei "cache-(from|to).*(docker\\.io|library/)" "/tmp/bake-${tgt}.txt"; then
              echo "docker.io reference detected in permutation cache refs ($tgt)"
              exit 1
            fi
            if ! grep -q "${{ env.BASE_IMAGE_TAG }}" "/tmp/bake-${tgt}.txt"; then
              echo "Expected BASE_IMAGE ${BASE_IMAGE_TAG} not found in permutation plan ($tgt)"
              exit 1
            fi
          done

      - name: Build base and devcontainers (single bake)
        uses: docker/bake-action@v6
        with:
          workdir: ${{ github.workspace }}
          source: .
          files: .devcontainer/docker-bake.hcl
          targets: all
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          load: true
          pull: false
          set: |
            base.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            base.cache-to=type=registry,ref=${{ env.BASE_CACHE_TAG }},mode=max,compression=zstd,oci-mediatypes=true,force-compression=true
            devcontainer_gcc14_clang_qual.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            devcontainer_gcc14_clang_dev.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            devcontainer_gcc14_clangp2996.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            devcontainer_gcc15_clang_qual.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            devcontainer_gcc15_clang_dev.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            devcontainer_gcc15_clangp2996.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            devcontainer_gcc14_clang_qual.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            devcontainer_gcc14_clang_dev.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            devcontainer_gcc14_clangp2996.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            devcontainer_gcc15_clang_qual.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            devcontainer_gcc15_clang_dev.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            devcontainer_gcc15_clangp2996.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            devcontainer_gcc14_clang_qual.tags=${{ env.TAG_BASE }}:gcc14-clang21
            devcontainer_gcc14_clang_qual.tags=${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}
            devcontainer_gcc14_clang_qual.tags=${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}
            devcontainer_gcc14_clang_dev.tags=${{ env.TAG_BASE }}:gcc14-clang22
            devcontainer_gcc14_clang_dev.tags=${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}
            devcontainer_gcc14_clang_dev.tags=${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}
            devcontainer_gcc14_clangp2996.tags=${{ env.TAG_BASE }}:gcc14-clangp2996
            devcontainer_gcc14_clangp2996.tags=${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}
            devcontainer_gcc14_clangp2996.tags=${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}
            devcontainer_gcc15_clang_qual.tags=${{ env.TAG_BASE }}:gcc15-clang21
            devcontainer_gcc15_clang_qual.tags=${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}
            devcontainer_gcc15_clang_qual.tags=${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}
            devcontainer_gcc15_clang_dev.tags=${{ env.TAG_BASE }}:gcc15-clang22
            devcontainer_gcc15_clang_dev.tags=${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}
            devcontainer_gcc15_clang_dev.tags=${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}
            devcontainer_gcc15_clangp2996.tags=${{ env.TAG_BASE }}:gcc15-clangp2996
            devcontainer_gcc15_clangp2996.tags=${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}
            devcontainer_gcc15_clangp2996.tags=${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}

      - name: Cleanup builder cache
        if: always()
        run: |
          docker builder prune -f --filter until=24h || true
          docker image prune -f --filter until=24h || true

      - name: Generate summary JSON and CSV
        if: always()
        run: |
          cat > "${SUMMARY_JSON}" <<'EOF'
          {
            "run_status": "${{ job.status }}",
            "targets": [
              {"name": "base", "status": "${{ job.status }}", "tags": ["${{ env.BASE_IMAGE_TAG }}"]},
              {"name": "devcontainer_gcc14_clang_qual", "status": "${{ job.status }}", "tags": ["${{ env.TAG_BASE }}:gcc14-clang21", "${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}", "${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}"]},
              {"name": "devcontainer_gcc14_clang_dev", "status": "${{ job.status }}", "tags": ["${{ env.TAG_BASE }}:gcc14-clang22", "${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}", "${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}"]},
              {"name": "devcontainer_gcc14_clangp2996", "status": "${{ job.status }}", "tags": ["${{ env.TAG_BASE }}:gcc14-clangp2996", "${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}", "${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}"]},
              {"name": "devcontainer_gcc15_clang_qual", "status": "${{ job.status }}", "tags": ["${{ env.TAG_BASE }}:gcc15-clang21", "${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}", "${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}"]},
              {"name": "devcontainer_gcc15_clang_dev", "status": "${{ job.status }}", "tags": ["${{ env.TAG_BASE }}:gcc15-clang22", "${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}", "${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}"]},
              {"name": "devcontainer_gcc15_clangp2996", "status": "${{ job.status }}", "tags": ["${{ env.TAG_BASE }}:gcc15-clangp2996", "${{ env.TAG_BASE }}:sha-${{ env.SHORT_SHA }}", "${{ env.TAG_BASE }}:ts-${{ env.BUILD_TS }}"]}
            ],
            "ghcr_package": "https://github.com/${{ github.repository }}/pkgs/container/devcontainer"
          }
          EOF
          # Emit CSV
          jq -r '.targets[] | [.name, .status, (.tags | join(";"))] | @csv' "${SUMMARY_JSON}" > summary.csv

      - name: Upload summary artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devcontainer-summary
          path: |
            ${{ env.SUMMARY_JSON }}
            summary.csv

      - name: Render summary table
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync(process.env.SUMMARY_JSON, 'utf8'));
            let table = "| Target | Status | Tags |\n| --- | --- | --- |\n";
            for (const t of data.targets) {
              table += `| ${t.name} | ${t.status} | ${t.tags.join(', ')} |\n`;
            }
            const pkg = data.ghcr_package || '';
            const tags = data.targets.flatMap(t => t.tags || []).join(', ');
            core.summary
              .addHeading('Devcontainer build')
              .addTable([
                [{data: 'Target', header: true}, {data: 'Status', header: true}, {data: 'Tags', header: true}],
                ...data.targets.map(t => [t.name, t.status, t.tags.join(', ')])
              ])
              .addBreak()
              .addRaw(`GHCR package: ${pkg}`)
              .addBreak()
              .addRaw(`All tags: ${tags}`)
              .write();
