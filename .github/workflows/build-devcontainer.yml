name: Build Devcontainers (Docker Bake)

on:
  push:
    branches: [ "main", "modernization.20251118" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: devcontainers-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  BUILDX_NO_DEFAULT_LOAD: 1
  TAG_BASE: ghcr.io/${{ github.repository }}/devcontainer
  BASE_IMAGE_TAG: ghcr.io/${{ github.repository }}/cpp-dev-base:local
  BASE_CACHE_TAG: ghcr.io/${{ github.repository }}/cpp-dev-base:cache
  EXPECTED_RUNNER_NAME: c0802s4-000
  EXPECTED_RUNNER_ALT: c0802s4
  CACHE_DIR: /var/cache/docker-buildx
  BUILDKIT_CONFIG: ${{ github.workspace }}/.github/buildkitd.toml

jobs:
  build-ci-helper:
    name: Build CI helper image
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4
    permissions:
      contents: read
      packages: write
      id-token: write
    timeout-minutes: 60
    steps:
      - name: Derive cache dir from Docker root
        id: cachepath-helper
        run: |
          set -euo pipefail
          root="$(docker info --format '{{.DockerRootDir}}')"
          target="${root}/buildx-cache"
          if sudo -n true 2>/dev/null; then
            sudo mkdir -p "$target"
            sudo chown "$(id -u):$(id -g)" "$target"
          else
            mkdir -p "$target" || true
          fi
          if [ -w "$target" ]; then
            echo "CACHE_DIR=$target" >> "$GITHUB_ENV"
          else
            fallback="${HOME}/.cache/docker-buildx"
            mkdir -p "$fallback"
            echo "CACHE_DIR=$fallback" >> "$GITHUB_ENV"
          fi

      - name: Runner guard
        run: |
          actual="$(hostname)"
          expected="${EXPECTED_RUNNER_NAME:-}"
          alt="${EXPECTED_RUNNER_ALT:-}"
          if [ -n "$expected" ] && [ "$actual" != "$expected" ] && { [ -z "$alt" ] || [ "$actual" != "$alt" ]; }; then
            echo "Runner guard failed: expected ${expected}${alt:+ or ${alt}}, got ${actual}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=ghcr.io/moby/buildkit:buildx-stable-1
            config=${{ github.workspace }}/.github/buildkitd.toml

      - name: Pre-pull buildkit/frontend images
        run: |
          docker pull ghcr.io/moby/buildkit:buildx-stable-1
          docker pull ghcr.io/docker/dockerfile:1.7
        with:
          driver-opts: |
            image=ghcr.io/moby/buildkit:buildx-stable-1
            config=${{ github.workspace }}/.github/buildkitd.toml

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Metadata for helper
        id: meta-helper
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/rmanaloto-tastytrade/cpp-devcontainers/ci-helper
          bake-target: ci-helper
          tags: |
            type=sha,format=short
            type=raw,value=latest

      - name: Persist helper metadata bake file
        run: cp "${{ steps.meta-helper.outputs.bake-file }}" meta-helper-bake.json

      - name: Build & push helper (bake)
        uses: docker/bake-action@v6
        with:
          workdir: ${{ github.workspace }}
          source: .
          files: |
            .devcontainer/docker-bake.hcl
            meta-helper-bake.json
          targets: ci-helper
          push: true

      - name: Cleanup builder cache
        if: always()
        run: |
          docker builder prune -f --filter until=24h || true
          docker image prune -f --filter until=24h || true

  build-devcontainers:
    name: Build devcontainer matrix
    needs: build-ci-helper
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4
    permissions:
      contents: read
      packages: write
      id-token: write
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        permutation:
          - gcc14-clang21
          - gcc14-clang22
          - gcc14-clangp2996
          - gcc15-clang21
          - gcc15-clang22
          - gcc15-clangp2996
    steps:
      - name: Derive cache dir from Docker root
        id: cachepath-dev
        run: |
          set -euo pipefail
          root="$(docker info --format '{{.DockerRootDir}}')"
          target="${root}/buildx-cache"
          if sudo -n true 2>/dev/null; then
            sudo mkdir -p "$target"
            sudo chown "$(id -u):$(id -g)" "$target"
          else
            mkdir -p "$target" || true
          fi
          if [ -w "$target" ]; then
            echo "CACHE_DIR=$target" >> "$GITHUB_ENV"
          else
            fallback="${HOME}/.cache/docker-buildx"
            mkdir -p "$fallback"
            echo "CACHE_DIR=$fallback" >> "$GITHUB_ENV"
          fi

      - name: Runner guard
        run: |
          actual="$(hostname)"
          expected="${EXPECTED_RUNNER_NAME:-}"
          alt="${EXPECTED_RUNNER_ALT:-}"
          if [ -n "$expected" ] && [ "$actual" != "$expected" ] && { [ -z "$alt" ] || [ "$actual" != "$alt" ]; }; then
            echo "Runner guard failed: expected ${expected}${alt:+ or ${alt}}, got ${actual}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate bake targets
        run: docker buildx bake --file .devcontainer/docker-bake.hcl --print

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Map permutation to bake target
        id: map
        run: |
          case "${{ matrix.permutation }}" in
            gcc14-clang21) echo "target=devcontainer_gcc14_clang_qual" >> $GITHUB_OUTPUT ;;
            gcc14-clang22) echo "target=devcontainer_gcc14_clang_dev" >> $GITHUB_OUTPUT ;;
            gcc14-clangp2996) echo "target=devcontainer_gcc14_clangp2996" >> $GITHUB_OUTPUT ;;
            gcc15-clang21) echo "target=devcontainer_gcc15_clang_qual" >> $GITHUB_OUTPUT ;;
            gcc15-clang22) echo "target=devcontainer_gcc15_clang_dev" >> $GITHUB_OUTPUT ;;
            gcc15-clangp2996) echo "target=devcontainer_gcc15_clangp2996" >> $GITHUB_OUTPUT ;;
            *) echo "Unknown permutation" >&2; exit 1 ;;
          esac

      - name: Guard against docker.io fallback
        run: |
          case "${BASE_IMAGE_TAG}" in
            ghcr.io/*) ;;
            *) echo "BASE_IMAGE_TAG must be ghcr.io/*, got ${BASE_IMAGE_TAG}"; exit 1 ;;
          esac
          case "${BASE_CACHE_TAG}" in
            ghcr.io/*) ;;
            *) echo "BASE_CACHE_TAG must be ghcr.io/*, got ${BASE_CACHE_TAG}"; exit 1 ;;
          esac
          BASE_TAG=${{ env.BASE_IMAGE_TAG }} BASE_CACHE_TAG=${{ env.BASE_CACHE_TAG }} \
            docker buildx bake --file .devcontainer/docker-bake.hcl --print base > /tmp/bake-print.txt
          if grep -Ei "docker\\.io|library/" /tmp/bake-print.txt; then
            echo "docker.io reference detected in base bake plan"
            exit 1
          fi
          if grep -Ei "cache-(from|to).*(docker\\.io|library/)" /tmp/bake-print.txt; then
            echo "docker.io reference detected in base cache refs"
            exit 1
          fi
          BASE_TAG=${{ env.BASE_IMAGE_TAG }} BASE_CACHE_TAG=${{ env.BASE_CACHE_TAG }} \
            docker buildx bake --file .devcontainer/docker-bake.hcl --print ${{ steps.map.outputs.target }} > /tmp/bake-target.txt
          if grep -Ei "docker\\.io|library/" /tmp/bake-target.txt; then
            echo "docker.io reference detected in permutation bake plan"
            exit 1
          fi
          if grep -Ei "cache-(from|to).*(docker\\.io|library/)" /tmp/bake-target.txt; then
            echo "docker.io reference detected in permutation cache refs"
            exit 1
          fi
          if ! grep -q "${{ env.BASE_IMAGE_TAG }}" /tmp/bake-target.txt; then
            echo "Expected BASE_IMAGE ${BASE_IMAGE_TAG} not found in permutation plan"
            exit 1
          fi

      - name: Metadata for devcontainer
        id: meta-dev
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.TAG_BASE }}
          bake-target: ${{ steps.map.outputs.target }}
          tags: |
            type=raw,value=${{ matrix.permutation }}
            type=sha,format=short,prefix=${{ matrix.permutation }}-
            type=raw,value=latest-${{ matrix.permutation }},enable=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

      - name: Persist devcontainer metadata bake file
        run: cp "${{ steps.meta-dev.outputs.bake-file }}" meta-dev-bake.json

      - name: Build base locally (no push)
        uses: docker/bake-action@v6
        with:
          workdir: ${{ github.workspace }}
          source: .
          files: .devcontainer/docker-bake.hcl
          targets: base
          load: true
          push: false
          pull: false
          set: |
            BASE_TAG=${{ env.BASE_IMAGE_TAG }}
            base.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            base.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}
            base.cache-to=type=registry,ref=${{ env.BASE_CACHE_TAG }},mode=max,compression=zstd,oci-mediatypes=true,force-compression=true

      - name: Hadolint Dockerfile
        run: |
          docker run --rm -i \
            -v "$PWD":/workspace -w /workspace \
            ghcr.io/rmanaloto-tastytrade/cpp-devcontainers/ci-helper:latest \
            hadolint --failure-threshold error - < .devcontainer/Dockerfile

      - name: Validate target
        run: docker buildx bake --file .devcontainer/docker-bake.hcl --print ${{ steps.map.outputs.target }}

      - name: Build devcontainer (bake)
        uses: docker/bake-action@v6
        with:
          workdir: ${{ github.workspace }}
          source: .
          files: |
            .devcontainer/docker-bake.hcl
            meta-dev-bake.json
          targets: ${{ steps.map.outputs.target }}
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          # Always load locally so images are available on the runner even when pushed
          load: true
          pull: false
          set: |
            BASE_TAG=${{ env.BASE_IMAGE_TAG }}
            ${{ steps.map.outputs.target }}.args.BASE_IMAGE=${{ env.BASE_IMAGE_TAG }}
            ${{ steps.map.outputs.target }}.cache-from=type=registry,ref=${{ env.BASE_CACHE_TAG }}

      - name: SBOM (best-effort)
        if: always()
        run: |
          primary_tag="${{ env.TAG_BASE }}:${{ matrix.permutation }}"
          docker sbom "$primary_tag" > /tmp/sbom-${{ matrix.permutation }}.txt || true

      - name: Summary
        if: always()
        run: |
          {
            echo "## Devcontainer build"
            echo ""
            echo "| Permutation | Status | Tags |"
            echo "| --- | --- | --- |"
            echo "| ${{ matrix.permutation }} | ${{ job.status }} | ${{ steps.meta-dev.outputs.tags }} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup builder cache
        if: always()
        run: |
          docker builder prune -f --filter until=24h || true
          docker image prune -f --filter until=24h || true
