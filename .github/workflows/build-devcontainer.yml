name: Build Devcontainer Images (self-hosted)

on:
  push:
    branches: [ "main", "modernization.20251118" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: build-${{ matrix.permutation }}
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4
    timeout-minutes: 120
    concurrency:
      group: devcontainer-${{ github.ref }}-build
      cancel-in-progress: true
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository

    strategy:
      fail-fast: false
      matrix:
        permutation:
          - gcc14-clang21
          - gcc14-clang22
          - gcc14-clangp2996
          - gcc15-clang21
          - gcc15-clang22
          - gcc15-clangp2996
    env:
      TAG_BASE: ghcr.io/${{ github.repository }}/devcontainer
      EXPECTED_RUNNER_NAME: c0802s4-000
      TAG_MAP_FILE: /tmp/devcontainer-tags.txt
      BUILDX_CACHE_DIR: /tmp/.buildx-cache
      BUILDX_CACHE_MODE: gha

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint Dockerfile (hadolint)
        run: docker run --rm -i hadolint/hadolint@sha256:9259e253a4e299b50c92006149dd3a171c7ea3c5bd36f060022b5d2c1ff0fbbe hadolint --failure-threshold error - < .devcontainer/Dockerfile

      - name: Preflight devcontainer/bake validation
        run: |
          ./scripts/check_docker_bake.sh
          npm install -g @devcontainers/cli
          devcontainer validate --workspace-folder .
          ./scripts/check_devcontainer_config.sh

      - name: Runner guard
        run: |
          if [ -n "${EXPECTED_RUNNER_NAME}" ]; then
            actual="$(hostname)"
            if [ "$actual" != "$EXPECTED_RUNNER_NAME" ]; then
              echo "Runner guard failed: expected ${EXPECTED_RUNNER_NAME}, got ${actual}"
              exit 1
            fi
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build permutation (no push)
        env:
          PERMUTATION: ${{ matrix.permutation }}
          PUSH_IMAGES: 0
          PUBLISH_LATEST: 0
          TAG_BASE: ${{ env.TAG_BASE }}
          TAG_MAP_FILE: ${{ env.TAG_MAP_FILE }}
          TAG_MAP_PERM: /tmp/tag-${{ matrix.permutation }}.txt
          EXPECTED_RUNNER_NAME: ${{ env.EXPECTED_RUNNER_NAME }}
          RUNNER_NAME: ${{ env.RUNNER_NAME }}
          BUILDX_CACHE_DIR: ${{ env.BUILDX_CACHE_DIR }}
          BUILDX_CACHE_MODE: ${{ env.BUILDX_CACHE_MODE }}
          OUTPUT_TAR: /tmp/devcontainer-${{ matrix.permutation }}.tar
          MANIFEST_FILE: /tmp/manifest-${{ matrix.permutation }}.json
        run: ./scripts/ci/build_devcontainers_ci.sh

      - name: Upload tag map
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devcontainer-tags-${{ matrix.permutation }}
          path: ${{ env.TAG_MAP_FILE }}
          retention-days: 7

      - name: Upload image tar
        uses: actions/upload-artifact@v4
        with:
          name: devcontainer-image-${{ matrix.permutation }}
          path: /tmp/devcontainer-${{ matrix.permutation }}.tar
          retention-days: 3

      - name: Upload per-permutation tag map
        uses: actions/upload-artifact@v4
        with:
          name: tag-permutation-${{ matrix.permutation }}
          path: /tmp/tag-${{ matrix.permutation }}.txt
          retention-days: 3

      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest-${{ matrix.permutation }}
          path: /tmp/manifest-${{ matrix.permutation }}.json
          retention-days: 3

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -f /tmp/devcontainer-${{ matrix.permutation }}.tar /tmp/tag-${{ matrix.permutation }}.txt /tmp/manifest-${{ matrix.permutation }}.json || true

      - name: Cleanup runner (build job)
        if: always()
        run: |
          docker image prune -af || true
          docker builder prune -af || true
          rm -rf /tmp/.buildx-cache* || true

  publish:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: publish
    runs-on:
      - self-hosted
      - devcontainer-builder
      - c0802s4-000
    timeout-minutes: 120
    env:
      TAG_BASE: ghcr.io/${{ github.repository }}/devcontainer
      EXPECTED_RUNNER_NAME: c0802s4-000
    concurrency:
      group: devcontainer-${{ github.ref }}-publish
      cancel-in-progress: true
    steps:
      - name: Runner guard
        run: |
          if [ -n "${EXPECTED_RUNNER_NAME}" ]; then
            actual="$(hostname)"
            if [ "$actual" != "$EXPECTED_RUNNER_NAME" ]; then
              echo "Runner guard failed: expected ${EXPECTED_RUNNER_NAME}, got ${actual}"
              exit 1
            fi
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cleanup before publish
        run: |
          docker image prune -af || true
          docker builder prune -af || true

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download images
        uses: actions/download-artifact@v4
        with:
          path: /tmp/images
          pattern: devcontainer-image-*

      - name: Download tag maps
        uses: actions/download-artifact@v4
        with:
          path: /tmp/tagmaps
          pattern: tag-permutation-*

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/manifests
          pattern: manifest-*

      - name: Validate artifacts and consolidate manifests/tag maps
        run: |
          set -euo pipefail
          expected=(gcc14-clang21 gcc14-clang22 gcc14-clangp2996 gcc15-clang21 gcc15-clang22 gcc15-clangp2996)
          tag_out=/tmp/tag-map-consolidated.txt
          man_out=/tmp/manifest-consolidated.jsonl
          : > "$tag_out"
          : > "$man_out"
          python3 -c $'import json, sys\\nfrom pathlib import Path\\nexpected=sys.argv[1:]\\nimages_dir=Path(\"/tmp/images\")\\ntagmaps_dir=Path(\"/tmp/tagmaps\")\\nmanifests_dir=Path(\"/tmp/manifests\")\\ntag_out=Path(\"/tmp/tag-map-consolidated.txt\")\\nman_out=Path(\"/tmp/manifest-consolidated.jsonl\")\\nseen=set()\\nfor perm in expected:\\n    tar_dir=images_dir/f\"devcontainer-image-{perm}\"\\n    tars=sorted(tar_dir.glob(\"*.tar\"))\\n    if len(tars)!=1: raise SystemExit(f\"Tarball missing or ambiguous for {perm}: {tars}\")\\n    tag_file=tagmaps_dir/f\"tag-permutation-{perm}\"/f\"tag-{perm}.txt\"\\n    if not tag_file.is_file(): raise SystemExit(f\"Tag map missing for {perm}: {tag_file}\")\\n    manifest_file=manifests_dir/f\"manifest-{perm}\"/f\"manifest-{perm}.json\"\\n    if not manifest_file.is_file(): raise SystemExit(f\"Manifest missing for {perm}: {manifest_file}\")\\n    entries=[json.loads(line.strip()) for line in manifest_file.read_text().splitlines() if line.strip()]\\n    if len(entries)!=1: raise SystemExit(f\"Manifest for {perm} must have exactly one entry, got {len(entries)}\")\\n    entry=entries[0]\\n    if entry.get(\"permutation\")!=perm: raise SystemExit(f\"Manifest permutation mismatch for {perm}: {entry.get('permutation')}\")\\n    if not entry.get(\"image_id\"): raise SystemExit(f\"Manifest missing image_id for {perm}\")\\n    if perm in seen: raise SystemExit(f\"Duplicate manifest entry for {perm}\")\\n    seen.add(perm)\\n    tag_out.open(\"a\",encoding=\"utf-8\").write(tag_file.read_text())\\n    man_out.open(\"a\",encoding=\"utf-8\").write(json.dumps(entry)+\"\\\\n\")\\nextra=[p.name for p in images_dir.glob(\"devcontainer-image-*\") if p.name.removeprefix(\"devcontainer-image-\") not in expected]\\nif extra: raise SystemExit(f\"Unexpected image artifacts present: {extra}\")' \"${expected[@]}\"'

      - name: Load, verify, scan, and push
        run: |
          set -euo pipefail
          expected=(gcc14-clang21 gcc14-clang22 gcc14-clangp2996 gcc15-clang21 gcc15-clang22 gcc15-clangp2996)
          manifest=/tmp/manifest-consolidated.jsonl
          map_file=/tmp/manifest-map.txt
          python3 -c $'import json, sys\\nfrom pathlib import Path\\nmanifest=Path(sys.argv[1])\\ncount=0\\nfor line in manifest.read_text().splitlines():\\n    line=line.strip()\\n    if not line: continue\\n    entry=json.loads(line)\\n    count+=1\\n    print(f\"{entry.get('permutation')} {entry.get('image_id')}\")\\nif count==0: raise SystemExit(\"No manifest entries found\")' "$manifest" > "$map_file"
          manifest_count=$(wc -l < "$map_file" | tr -d ' ')
          expected_count=${#expected[@]}
          if [ "$manifest_count" -ne "$expected_count" ]; then
            echo "Manifest entries mismatch: expected $expected_count, found $manifest_count" >&2
            exit 1
          fi
          while read -r perm expected_id; do
            if [ -z "$perm" ]; then
              echo "Empty permutation entry in manifest map" >&2
              exit 1
            fi
            tar_dir="/tmp/images/devcontainer-image-${perm}"
            tar_path=$(find "$tar_dir" -maxdepth 1 -type f -name "*.tar" | head -n1)
            if [ -z "$tar_path" ]; then
              echo "Missing tarball for ${perm}" >&2
              exit 1
            fi
            docker load -i "$tar_path"
            TAG="${TAG_BASE}:${perm}"
            docker tag "$TAG" "${TAG_BASE}:${GITHUB_SHA}-${perm}"
            actual_id=$(docker image inspect --format='{{.Id}}' "$TAG")
            if [ "$actual_id" != "$expected_id" ]; then
              echo "Image ID mismatch for ${perm}: manifest=${expected_id} actual=${actual_id}" >&2
              exit 1
            fi
            docker sbom "$TAG" > "/tmp/sbom-${perm}.txt"
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy@sha256:1274d635b5bc35503ec21a82f7bca3d735d95cca239352b04c082686061dc751 image --severity CRITICAL,HIGH,MEDIUM --exit-code 1 "$TAG"
            docker push "$TAG"
            docker push "${TAG_BASE}:${GITHUB_SHA}-${perm}"
          done < "$map_file"

      - name: Upload SBOMs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sboms
          path: /tmp/sbom-*.txt
          retention-days: 7

      - name: Upload consolidated tag map
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tag-map-consolidated
          path: /tmp/tag-map-consolidated.txt
          retention-days: 7

      - name: Upload consolidated manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manifest-consolidated
          path: /tmp/manifest-consolidated.jsonl
          retention-days: 7

      - name: Cleanup runner
        if: always()
        run: |
          docker image prune -af || true
          docker builder prune -af || true
          rm -f /tmp/devcontainer-*.tar /tmp/images/devcontainer-image-*.tar /tmp/tag-map-consolidated.txt || true
          rm -rf /tmp/images /tmp/tagmaps /tmp/manifests || true
          rm -rf /tmp/tag-map-consolidated.txt /tmp/manifest-consolidated.jsonl || true
